[virtual_sdcard]
path: ~/gcode_files

[display_status]

[pause_resume]
recover_velocity: 300.0

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    {% set X = params.X|default(185) %} # edit to your park position
    {% set Y = params.Y|default(305) %} # edit to your park position
    {% set Z = params.Z|default(5) %} # edit to your park position
    {% set E = params.E|default(1) %} # edit to your retract length
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{E} F2100
    G1 Z{Z} F6000
    SAVE_GCODE_STATE NAME=PAUSE_above_state
    G90
    G1 X{X} Y{Y} F6000
    STATUS_READY
    light_on S=50

[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_prime: True
gcode:
    {% set E = params.E|default(1) %} # edit to your retract length
    {% if printer["gcode_macro ERCF_HOME"].home != 1 %}
      G91
      G1 E{E} F2100
      G90
      {% if not printer["filament_switch_sensor toolhead_sensor"].filament_detected %}
        M117 No filament detected
      {% else %}
        RESTORE_GCODE_STATE NAME=PAUSE_above_state MOVE=1
        RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
        BASE_RESUME
        STATUS_PRINTING
      {% endif %}
    {% else %}
      {% if printer["gcode_macro ERCF_PAUSE"].is_paused|int != 0 %}
        M118 You cannot resume the print without unlocking the ERCF first.
        M118 Run ERCF_UNLOCK and solve any issue before hitting Resume again
      {% else %}
        RESTORE_GCODE_STATE NAME=PAUSE_above_state MOVE=1
        RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
        G90
        {% if printer["gcode_macro ERCF_VAR"].clog_detection|int == 1 %}
          SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1
        {% endif %}
        BASE_RESUME
        STATUS_PRINTING
      {% endif %}
    {% endif %}
    light_on S=30
	
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    SDCARD_RESET_FILE
    PRINT_END
    BASE_CANCEL_PRINT

[idle_timeout]
gcode:
	{% if "xyz" in printer.toolhead.homed_axes %}
		G91                          	 																	; relative positioning
		G1 Z5 F18000.0                      																; move up 5mm
		G90                                 																; absolute positioning
		G1 X{printer.toolhead.axis_maximum.x} Y{printer.toolhead.axis_maximum.y} F18000.0  					; park nozzle at rear
	{% endif %}
	OFF																										; turn everything off
timeout: 7200 # 2 hrs
